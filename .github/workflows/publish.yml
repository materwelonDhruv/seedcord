name: publish

on:
    workflow_run:
        workflows: ['tests']
        types: [completed]
        branches: [main]
    workflow_dispatch: {}

permissions:
    contents: write
    id-token: write
    pull-requests: write

concurrency:
    group: release-${{ github.ref_name }}
    cancel-in-progress: true

jobs:
    dry-run-npm:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v5
              with:
                  fetch-depth: 0
            - uses: pnpm/action-setup@v4
            - run: pnpm install --frozen-lockfile
            - run: pnpm publish --dry-run --workspace-root --no-git-checks

    npm-publish:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        needs: dry-run-npm
        runs-on: ubuntu-latest
        timeout-minutes: 30
        permissions:
            contents: write
            id-token: write
            pull-requests: write
        steps:
            - uses: actions/checkout@v5
              with:
                  fetch-depth: 0
            - name: Turbo cache
              uses: ./.github/actions/turbo-cache
              with:
                  turbo_token: ${{ secrets.TURBO_TOKEN }}
                  turbo_team: ${{ vars.TURBO_TEAM }}
                  enable_fallback_cache: 'true'
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v6
              with:
                  node-version: 24
                  cache: pnpm
                  registry-url: https://registry.npmjs.org
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v6
              with:
                  node-version: 24
                  cache: pnpm
                  registry-url: https://registry.npmjs.org
            - run: npm i -g npm@latest
            - run: node -v && npm -v
            - run: npm config get registry && npm ping
            - run: pnpm install --frozen-lockfile
            - run: pnpm run prepublishOnly

            - id: changesets
              uses: changesets/action@v1
              if: ${{ github.event.workflow_run.event == 'push' && github.event.workflow_run.head_repository.full_name == github.repository }}
              with:
                  publish: pnpm run release
                  commit: 'chore(release): version packages'
                  title: 'chore: release packages'
                  branch: 'main'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  HUSKY: 0
